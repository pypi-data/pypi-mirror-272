# This workflow builds an apptainer with tike installed

name: Publish Apptainer

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    tags:
    # Use pattern matching to only run on version release tags
    - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: read
  packages: write

jobs:

  publish-apptainer-to-ghcr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: eWaterCycle/setup-apptainer@v2
      with:
        apptainer-version: 1.3.0
    - name: Build container from definition
      run: apptainer build tike.sif apptainer/tike.def
    - name: Upload to container registry
      run: |
        echo ${{ secrets.GITHUB_TOKEN }} | apptainer registry login -u ${{ github.actor }} --password-stdin oras://ghcr.io
        apptainer push tike.sif oras://ghcr.io/${GITHUB_REPOSITORY,,}:${{ github.ref_name }}
