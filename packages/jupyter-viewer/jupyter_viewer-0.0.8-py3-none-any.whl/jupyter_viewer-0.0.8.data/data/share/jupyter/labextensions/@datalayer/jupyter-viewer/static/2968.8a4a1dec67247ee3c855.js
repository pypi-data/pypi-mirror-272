"use strict";(self.webpackChunk_datalayer_jupyter_viewer=self.webpackChunk_datalayer_jupyter_viewer||[]).push([[2968],{62968:(e,t,s)=>{s.r(t),s.d(t,{default:()=>Ut});var n=s(56653),o=s(96129),r=s(56199),a=s(50555),i=s(82213),c=s(32850),l=s(67370),d=s(62086),h=s(18093),u=s(97930);const p=new u.Token("@jupyter/collaboration-extension:ICollaborativeDrive");var f=s(1865),g=s(66274),m=s(74901),y=s(90981);const b=()=>new Map,v=(e,t,s)=>{let n=e.get(t);return void 0===n&&e.set(t,n=s()),n},w=()=>new Set,_=String.fromCharCode,C=(String.fromCodePoint,_(65535),/^\s*/g),k=/([A-Z])/g,I=(e,t)=>(e=>e.replace(C,""))(e.replace(k,(e=>`${t}${(e=>e.toLowerCase())(e)}`))),S="undefined"!=typeof TextEncoder?new TextEncoder:null,x=S?e=>S.encode(e):e=>{const t=unescape(encodeURIComponent(e)),s=t.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=t.codePointAt(e);return n};let A="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});A&&1===A.decode(new Uint8Array).length&&(A=null);let j=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},M=!0;try{"undefined"!=typeof localStorage&&localStorage&&(j=localStorage,M=!1)}catch(e){}const U=j,T=Array.from,E=(Array.isArray,Object.assign,Object.keys),L=e=>E(e).length,R=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),D=(e,t)=>{if(null==e||null==t)return((e,t)=>e===t)(e,t);if(e.constructor!==t.constructor)return!1;if(e===t)return!0;switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;break;case Set:if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;break;case Map:if(e.size!==t.size)return!1;for(const s of e.keys())if(!t.has(s)||!D(e.get(s),t.get(s)))return!1;break;case Object:if(L(e)!==L(t))return!1;for(const s in e)if(!R(e,s)||!D(e[s],t[s]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!D(e[s],t[s]))return!1;break;default:return!1}return!0};var P=s(13158);const B=void 0!==P&&P.release&&/node|io\.js/.test(P.release.name)&&"[object process]"===Object.prototype.toString.call(void 0!==P?P:0),N="undefined"!=typeof window&&"undefined"!=typeof document&&!B;let F;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);const O=[],$=e=>(()=>{if(void 0===F)if(B){F=b();const e=P.argv;let t=null;for(let s=0;s<e.length;s++){const n=e[s];"-"===n[0]?(null!==t&&F.set(t,""),t=n):null!==t?(F.set(t,n),t=null):O.push(n)}null!==t&&F.set(t,"")}else"object"==typeof location?(F=b(),(location.search||"?").slice(1).split("&").forEach((e=>{if(0!==e.length){const[t,s]=e.split("=");F.set(`--${I(t,"-")}`,s),F.set(`-${I(t,"-")}`,s)}}))):F=b();return F})().has(e),W=e=>{return void 0===(t=B?P.env[e.toUpperCase()]:U.getItem(e))?null:t;var t};$("--"+"production")||W("production");const H=B&&(q=P.env.FORCE_COLOR,["true","1","2"].includes(q));var q;!$("no-colors")&&(!B||P.stdout.isTTY||H)&&(!B||$("color")||H||null!==W("COLORTERM")||(W("TERM")||"").includes("color"));const J=N?e=>{let t="";for(let s=0;s<e.byteLength;s++)t+=_(e[s]);return btoa(t)}:e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),z=N?e=>{const t=atob(e),s=(n=t.length,new Uint8Array(n));var n;for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s}:e=>{const t=Buffer.from(e,"base64");return s=t.buffer,n=t.byteOffset,o=t.byteLength,new Uint8Array(s,n,o);var s,n,o},G=new Map,V="undefined"==typeof BroadcastChannel?class{constructor(e){var t;this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&null!==this.onmessage&&this.onmessage({data:z(t.newValue||"")}),t=this._onChange,M||addEventListener("storage",t)}postMessage(e){U.setItem(this.room,J(new Uint8Array(e)))}close(){var e;e=this._onChange,M||removeEventListener("storage",e)}}:BroadcastChannel,Y=e=>v(G,e,(()=>{const t=w(),s=new V(e);return s.onmessage=e=>t.forEach((t=>t(e.data,"broadcastchannel"))),{bc:s,subs:t}})),X=(e,t,s=null)=>{const n=Y(e);n.bc.postMessage(t),n.subs.forEach((e=>e(t,s)))},Z=Date.now,K=Math.floor,Q=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,(e,t)=>e<t?e:t),ee=(Number.isNaN,Math.pow),te=(Math.sign,128),se=127;class ne{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const oe=()=>new ne,re=e=>{let t=e.cpos;for(let s=0;s<e.bufs.length;s++)t+=e.bufs[s].length;return t},ae=e=>{const t=new Uint8Array(re(e));let s=0;for(let n=0;n<e.bufs.length;n++){const o=e.bufs[n];t.set(o,s),s+=o.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),s),t},ie=(e,t)=>{const s=e.cbuf.length;e.cpos===s&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*s),e.cpos=0),e.cbuf[e.cpos++]=t},ce=(e,t)=>{for(;t>se;)ie(e,te|se&t),t=K(t/128);ie(e,se&t)},le=new Uint8Array(3e4),de=le.length/3,he=S&&S.encodeInto?(e,t)=>{if(t.length<de){const s=S.encodeInto(t,le).written||0;ce(e,s);for(let t=0;t<s;t++)ie(e,le[t])}else ue(e,x(t))}:(e,t)=>{const s=unescape(encodeURIComponent(t)),n=s.length;ce(e,n);for(let t=0;t<n;t++)ie(e,s.codePointAt(t))},ue=(e,t)=>{ce(e,t.byteLength),((e,t)=>{const s=e.cbuf.length,n=e.cpos,o=Q(s-n,t.length),r=t.length-o;var a,i;e.cbuf.set(t.subarray(0,o),n),e.cpos+=o,r>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array((a=2*s)>(i=r)?a:i),e.cbuf.set(t.subarray(o)),e.cpos=r)})(e,t)};new DataView(new ArrayBuffer(4));const pe=Number.MAX_SAFE_INTEGER,fe=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),ge=fe("Unexpected end of array"),me=fe("Integer out of Range");class ye{constructor(e){this.arr=e,this.pos=0}}const be=e=>new ye(e),ve=e=>((e,t)=>{const s=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,s})(e,_e(e)),we=e=>e.arr[e.pos++],_e=e=>{let t=0,s=1;const n=e.arr.length;for(;e.pos<n;){const n=e.arr[e.pos++];if(t+=(n&se)*s,s*=128,n<te)return t;if(t>pe)throw me}throw ge},Ce=A?e=>A.decode(ve(e)):e=>{let t=_e(e);if(0===t)return"";{let s=String.fromCodePoint(we(e));if(--t<100)for(;t--;)s+=String.fromCodePoint(we(e));else for(;t>0;){const n=t<1e4?t:1e4,o=e.arr.subarray(e.pos,e.pos+n);e.pos+=n,s+=String.fromCodePoint.apply(null,o),t-=n}return decodeURIComponent(escape(s))}},ke=(e,t)=>{ce(e,0);const s=y.encodeStateVector(t);ue(e,s)},Ie=(e,t,s)=>{ce(e,1),ue(e,y.encodeStateAsUpdate(t,s))},Se=(e,t,s)=>{try{y.applyUpdate(t,ve(e),s)}catch(e){console.error("Caught error while handling a Yjs update",e)}},xe=Se;class Ae{constructor(){this._observers=b()}on(e,t){v(this._observers,e,w).add(t)}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}off(e,t){const s=this._observers.get(e);void 0!==s&&(s.delete(t),0===s.size&&this._observers.delete(e))}emit(e,t){return T((this._observers.get(e)||b()).values()).forEach((e=>e(...t)))}destroy(){this._observers=b()}}class je extends Ae{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval((()=>{const e=Z();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach(((s,n)=>{n!==this.clientID&&3e4<=e-s.lastUpdated&&this.states.has(n)&&t.push(n)})),t.length>0&&Me(this,t,"timeout")}),K(3e3)),e.on("destroy",(()=>{this.destroy()})),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,s=this.meta.get(t),n=void 0===s?0:s.clock+1,o=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:n,lastUpdated:Z()});const r=[],a=[],i=[],c=[];null===e?c.push(t):null==o?null!=e&&r.push(t):(a.push(t),D(o,e)||i.push(t)),(r.length>0||i.length>0||c.length>0)&&this.emit("change",[{added:r,updated:i,removed:c},"local"]),this.emit("update",[{added:r,updated:a,removed:c},"local"])}setLocalStateField(e,t){const s=this.getLocalState();null!==s&&this.setLocalState({...s,[e]:t})}getStates(){return this.states}}const Me=(e,t,s)=>{const n=[];for(let s=0;s<t.length;s++){const o=t[s];if(e.states.has(o)){if(e.states.delete(o),o===e.clientID){const t=e.meta.get(o);e.meta.set(o,{clock:t.clock+1,lastUpdated:Z()})}n.push(o)}}n.length>0&&(e.emit("change",[{added:[],updated:[],removed:n},s]),e.emit("update",[{added:[],updated:[],removed:n},s]))},Ue=(e,t,s=e.states)=>{const n=t.length,o=oe();ce(o,n);for(let r=0;r<n;r++){const n=t[r],a=s.get(n)||null,i=e.meta.get(n).clock;ce(o,n),ce(o,i),he(o,JSON.stringify(a))}return ae(o)};var Te=s(13158);const Ee=[];Ee[0]=(e,t,s,n,o)=>{ce(e,0);const r=((e,t,s,n)=>{const o=_e(e);switch(o){case 0:((e,t,s)=>{Ie(t,s,ve(e))})(e,t,s);break;case 1:Se(e,s,n);break;case 2:xe(e,s,n);break;default:throw new Error("Unknown message type")}return o})(t,e,s.doc,s);n&&1===r&&!s.synced&&(s.synced=!0)},Ee[3]=(e,t,s,n,o)=>{ce(e,1),ue(e,Ue(s.awareness,Array.from(s.awareness.getStates().keys())))},Ee[1]=(e,t,s,n,o)=>{((e,t,s)=>{const n=be(t),o=Z(),r=[],a=[],i=[],c=[],l=_e(n);for(let t=0;t<l;t++){const t=_e(n);let s=_e(n);const l=JSON.parse(Ce(n)),d=e.meta.get(t),h=e.states.get(t),u=void 0===d?0:d.clock;(u<s||u===s&&null===l&&e.states.has(t))&&(null===l?t===e.clientID&&null!=e.getLocalState()?s++:e.states.delete(t):e.states.set(t,l),e.meta.set(t,{clock:s,lastUpdated:o}),void 0===d&&null!==l?r.push(t):void 0!==d&&null===l?c.push(t):null!==l&&(D(l,h)||i.push(t),a.push(t)))}(r.length>0||i.length>0||c.length>0)&&e.emit("change",[{added:r,updated:i,removed:c},s]),(r.length>0||a.length>0||c.length>0)&&e.emit("update",[{added:r,updated:a,removed:c},s])})(s.awareness,ve(t),s)},Ee[2]=(e,t,s,n,o)=>{((e,t,s)=>{0===_e(e)&&s(0,Ce(e))})(t,s.doc,((e,t)=>Le(s,t)))};const Le=(e,t)=>console.warn(`Permission denied to access ${e.url}.\n${t}`),Re=(e,t,s)=>{const n=be(t),o=oe(),r=_e(n),a=e.messageHandlers[r];return a?a(o,n,e,s,r):console.error("Unable to compute message"),o},De=e=>{if(e.shouldConnect&&null===e.ws){const t=new e._WS(e.url);t.binaryType="arraybuffer",e.ws=t,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,t.onmessage=s=>{e.wsLastMessageReceived=Z();const n=Re(e,new Uint8Array(s.data),!0);re(n)>1&&t.send(ae(n))},t.onerror=t=>{e.emit("connection-error",[t,e])},t.onclose=t=>{e.emit("connection-close",[t,e]),e.ws=null,e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,Me(e.awareness,Array.from(e.awareness.getStates().keys()).filter((t=>t!==e.doc.clientID)),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(De,Q(100*ee(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e)},t.onopen=()=>{e.wsLastMessageReceived=Z(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const s=oe();if(ce(s,0),ke(s,e.doc),t.send(ae(s)),null!==e.awareness.getLocalState()){const s=oe();ce(s,1),ue(s,Ue(e.awareness,[e.doc.clientID])),t.send(ae(s))}},e.emit("status",[{status:"connecting"}])}},Pe=(e,t)=>{e.wsconnected&&e.ws.send(t),e.bcconnected&&X(e.bcChannel,t,e)};class Be extends Ae{constructor(e,t,s,{connect:n=!0,awareness:o=new je(s),params:r={},WebSocketPolyfill:a=WebSocket,resyncInterval:i=-1,maxBackoffTime:c=2500,disableBc:l=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);const d=(e=>((e,t)=>{const s=[];for(const n in e)s.push(t(e[n],n));return s})(e,((e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join("&"))(r);this.maxBackoffTime=c,this.bcChannel=e+"/"+t,this.url=e+"/"+t+(0===d.length?"":"?"+d),this.roomname=t,this.doc=s,this._WS=a,this.awareness=o,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=l,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Ee.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=n,this._resyncInterval=0,i>0&&(this._resyncInterval=setInterval((()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=oe();ce(e,0),ke(e,s),this.ws.send(ae(e))}}),i)),this._bcSubscriber=(e,t)=>{if(t!==this){const t=Re(this,new Uint8Array(e),!1);re(t)>1&&X(this.bcChannel,ae(t),this)}},this._updateHandler=(e,t)=>{if(t!==this){const t=oe();ce(t,0),((e,t)=>{ce(e,2),ue(e,t)})(t,e),Pe(this,ae(t))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:t,removed:s},n)=>{const r=e.concat(t).concat(s),a=oe();ce(a,1),ue(a,Ue(o,r)),Pe(this,ae(a))},this._unloadHandler=()=>{Me(this.awareness,[s.clientID],"window unload")},"undefined"!=typeof window?window.addEventListener("unload",this._unloadHandler):void 0!==Te&&Te.on("exit",this._unloadHandler),o.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval((()=>{this.wsconnected&&3e4<Z()-this.wsLastMessageReceived&&this.ws.close()}),3e3),n&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),"undefined"!=typeof window?window.removeEventListener("unload",this._unloadHandler):void 0!==Te&&Te.off("exit",this._unloadHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,t;this.bcconnected||(e=this.bcChannel,t=this._bcSubscriber,Y(e).subs.add(t),this.bcconnected=!0);const s=oe();ce(s,0),ke(s,this.doc),X(this.bcChannel,ae(s),this);const n=oe();ce(n,0),Ie(n,this.doc),X(this.bcChannel,ae(n),this);const o=oe();ce(o,3),X(this.bcChannel,ae(o),this);const r=oe();ce(r,1),ue(r,Ue(this.awareness,[this.doc.clientID])),X(this.bcChannel,ae(r),this)}disconnectBc(){const e=oe();ce(e,1),ue(e,Ue(this.awareness,[this.doc.clientID],new Map)),Pe(this,ae(e)),this.bcconnected&&(((e,t)=>{const s=Y(e);s.subs.delete(t)&&0===s.subs.size&&(s.bc.close(),G.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&this.ws.close()}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(De(this),this.connectBc())}}class Ne{constructor(e){this._onConnectionClosed=e=>{1003===e.code&&(console.error("Document provider closed:",e.reason),(0,o.showErrorMessage)(this._trans.__("Document session error"),e.reason,[o.Dialog.okButton()]),this._sharedModel.dispose())},this._onSync=e=>{var t;e&&(this._ready.resolve(),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync))},this._ready=new u.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebsocketProvider=null,this._trans=e.translator;const t=e.user;t.ready.then((()=>{this._onUserChanged(t)})).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._connect().catch((e=>console.warn(e)))}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}dispose(){var e,t,s;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(s=this._yWebsocketProvider)||void 0===s||s.destroy(),m.Signal.clearData(this))}async _connect(){const e=await async function(e,t,s){const n=g.ServerConnection.makeSettings(),o=f.URLExt.join(n.baseUrl,"api/collaboration/session",encodeURIComponent(s)),r={method:"PUT",body:JSON.stringify({format:e,type:t})};let a;try{a=await g.ServerConnection.makeRequest(o,r,n)}catch(e){throw new g.ServerConnection.NetworkError(e)}let i=await a.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new g.ServerConnection.ResponseError(a,i.message||i);return i}(this._format,this._contentType,this._path);this._yWebsocketProvider=new Be(this._serverUrl,`${e.format}:${e.type}:${e.fileId}`,this._sharedModel.ydoc,{disableBc:!0,params:{sessionId:e.sessionId},awareness:this._awareness}),this._yWebsocketProvider.on("sync",this._onSync),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed)}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}const Fe="true"===f.PageConfig.getOption("disableRTC");class Oe extends g.Drive{constructor(e,t){super({name:"RTC"}),this._onCreate=(e,t)=>{if("string"==typeof e.format)try{const s=new Ne({url:f.URLExt.join(this.serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:t,user:this._user,translator:this._trans}),n=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(n,s),t.disposed.connect((()=>{const e=this._providers.get(n);e&&(e.dispose(),this._providers.delete(n))}))}catch(t){console.error(`Failed to open websocket connection for ${e.path}.\n:${t}`)}},this._user=e,this._trans=t,this._providers=new Map,this.sharedModelFactory=new $e(this._onCreate)}dispose(){this.isDisposed||(this._providers.forEach((e=>e.dispose())),this._providers.clear(),super.dispose())}async get(e,t){if(t&&t.format&&t.type){const s=`${t.format}:${t.type}:${e}`,n=this._providers.get(s);if(n){const s=super.get(e,{...t,content:!1});return await n.ready,s}}return super.get(e,t)}async save(e,t={}){if(t.format&&t.type){const s=`${t.format}:${t.type}:${e}`;if(this._providers.get(s))return this.get(e,{...t,content:!1})}return super.save(e,t)}}class $e{constructor(e){this._onCreate=e,this.collaborative=!Fe,this._documentFactories=new Map}registerDocumentFactory(e,t){if(this._documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this._documentFactories.set(e,t)}createNew(e){if("string"==typeof e.format){if(this.collaborative&&e.collaborative&&this._documentFactories.has(e.contentType)){const t=this._documentFactories.get(e.contentType)(e);return this._onCreate(e,t),t}}else console.warn(`Only defined format are supported; got ${e.format}.`)}}var We;!function(e){e.openPath="filebrowser:open-path"}(We||(We={}));const He={id:"@jupyter/collaboration-extension:drive",description:"The default collaborative drive provider",provides:p,requires:[d.ITranslator],optional:[],activate:(e,t)=>{const s=t.load("jupyter_collaboration"),n=new Oe(e.serviceManager.user,s);return e.serviceManager.contents.addDrive(n),n}},qe={id:"@jupyter/collaboration-extension:yfile",description:"Plugin to register the shared model factory for the content type 'file'",autoStart:!0,requires:[p],optional:[],activate:(e,t)=>{t.sharedModelFactory.registerDocumentFactory("file",(()=>new h.YFile))}},Je={id:"@jupyter/collaboration-extension:ynotebook",description:"Plugin to register the shared model factory for the content type 'notebook'",autoStart:!0,requires:[p],optional:[l.ISettingRegistry],activate:(e,t,s)=>{let n=!0;s&&s.load("@jupyterlab/notebook-extension:tracker").then((e=>{const t=e=>{var t;const s=null==e?void 0:e.get("experimentalEnableDocumentWideUndoRedo").composite;n=null===(t=!s)||void 0===t||t};t(e),e.changed.connect((e=>t(e)))})),t.sharedModelFactory.registerDocumentFactory("notebook",(()=>new h.YNotebook({disableDocumentWideUndoRedo:n})))}},ze={id:"@jupyter/collaboration-extension:defaultFileBrowser",description:"The default file browser factory provider",provides:r.IDefaultFileBrowser,requires:[p,r.IFileBrowserFactory],optional:[n.IRouter,n.JupyterFrontEnd.ITreeResolver,n.ILabShell,l.ISettingRegistry],activate:async(e,t,s,n,o,r)=>{const{commands:a}=e;e.serviceManager.contents.addDrive(t);const i=s.createFileBrowser("filebrowser",{auto:!1,restore:!1,driveName:t.name});return Ve.restoreBrowser(i,a,n,o,r),i}},Ge={id:"@jupyter/collaboration-extension:logger",description:"A logging plugin for debugging purposes.",autoStart:!0,optional:[i.ILoggerRegistry,a.IEditorTracker,c.INotebookTracker,d.ITranslator],activate:(e,t,s,n,r)=>{const a=(null!=r?r:d.nullTranslator).load("jupyter_collaboration"),i="https://schema.jupyter.org/jupyter_collaboration/session/v1";if(!t)return void e.serviceManager.events.stream.connect(((e,t)=>{var s,n;t.schema_id===i&&(console.debug(`[${t.room}(${t.path})] ${null!==(s=t.action)&&void 0!==s?s:""}: ${null!==(n=t.msg)&&void 0!==n?n:""}`),"WARNING"===t.level&&(0,o.showDialog)({title:a.__("Warning"),body:a.__(`Two collaborative sessions are accessing the file ${t.path} simultaneously.\n                \nOpening the same file using different views simultaneously is not supported. Please, close one view; otherwise, you might lose some of your progress.`),buttons:[o.Dialog.okButton()]}))}));const c=new Map,l=(e,s)=>{const n=t.getLogger(s.context.path);c.set(s.context.localPath,n),s.disposed.connect((e=>{c.delete(e.context.localPath)}))};s&&s.widgetAdded.connect(l),n&&n.widgetAdded.connect(l),(async()=>{var t,s;const{events:n}=e.serviceManager;for await(const e of n.stream)if(e.schema_id===i){const n=c.get(e.path);null==n||n.log({type:"text",level:e.level.toLowerCase(),data:`[${e.room}] ${null!==(t=e.action)&&void 0!==t?t:""}: ${null!==(s=e.msg)&&void 0!==s?s:""}`}),"WARNING"===e.level&&(0,o.showDialog)({title:a.__("Warning"),body:a.__("Two collaborative sessions are accessing the file %1 simultaneously.\n                \nOpening a document with multiple views simultaneously is not supported. Please close one view; otherwise, you might lose some of your progress.",e.path),buttons:[o.Dialog.warnButton({label:a.__("Ok")})]})}})()}};var Ve;!function(e){e.restoreBrowser=async function(e,t,s,n,o){const r="jp-mod-restoring";if(e.addClass(r),!s)return await e.model.restore(e.id),await e.model.refresh(),void e.removeClass(r);const a=async()=>{s.routed.disconnect(a);const i=await(null==n?void 0:n.paths);(null==i?void 0:i.file)||(null==i?void 0:i.browser)?(await e.model.restore(e.id,!1),i.file&&await t.execute(We.openPath,{path:i.file,dontShowBrowser:!0}),i.browser&&await t.execute(We.openPath,{path:i.browser,dontShowBrowser:!0})):(await e.model.restore(e.id),await e.model.refresh()),e.removeClass(r),(null==o?void 0:o.isEmpty("main"))&&t.execute("launcher:create")};s.routed.connect(a)}}(Ve||(Ve={}));var Ye=s(25360);const Xe=new u.Token("@jupyter/collaboration:IUserMenu"),Ze=new u.Token("@jupyter/collaboration:IGlobalAwareness");var Ke=s(40158),Qe=s(34882),et=s(84059);class tt extends Qe.MenuBar.Renderer{constructor(e){super(),this._user=e}renderItem(e){const t=this.createItemClass(e),s=this.createItemDataset(e),n=this.createItemARIA(e);return et.h.li({className:t,dataset:s,tabindex:"0",onfocus:e.onfocus,...n},this._createUserIcon(),this.renderLabel(e),this.renderIcon(e))}renderLabel(e){const t=this.formatLabel(e);return et.h.div({className:"lm-MenuBar-itemLabel jp-MenuBar-label"},t)}_createUserIcon(){return this._user.isReady&&this._user.identity.avatar_url?et.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-imageIcon"},et.h.img({src:this._user.identity.avatar_url})):this._user.isReady?et.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon",style:{backgroundColor:this._user.identity.color}},et.h.span({},this._user.identity.initials)):et.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon"},Ke.userIcon)}}class st extends Qe.Menu{constructor(e){super(e)}}var nt=s(66029);const ot=e=>{const{user:t}=e;return nt.createElement("div",{className:"jp-UserInfo-Container"},nt.createElement("div",{title:t.display_name,className:"jp-UserInfo-Icon",style:{backgroundColor:t.color}},nt.createElement("span",null,t.initials)),nt.createElement("h3",null,t.display_name))};class rt extends Qe.Panel{constructor(e){super({}),this.addClass("jp-UserInfoPanel"),this._profile=e,this._body=null,this._profile.isReady?(this._body=new at(this._profile.identity),this.addWidget(this._body),this.update()):this._profile.ready.then((()=>{this._body=new at(this._profile.identity),this.addWidget(this._body),this.update()})).catch((e=>console.error(e)))}}class at extends o.ReactWidget{constructor(e){super(),this._user=e}get user(){return this._user}set user(e){this._user=e,this.update()}render(){return nt.createElement(ot,{user:this._user})}}const it="jp-Collaborator";class ct extends Qe.Panel{constructor(e,t,s){super({}),this._onAwarenessChanged=()=>{const e=this._awareness.getStates(),t=[];e.forEach(((e,s)=>{this._currentUser.isReady&&e.user.name!==this._currentUser.identity.name&&t.push(e)})),this._body.collaborators=t},this._awareness=t,this._currentUser=e,this.addClass("jp-CollaboratorsPanel"),this._body=new lt(s),this.addWidget(this._body),this.update(),this._awareness.on("change",this._onAwarenessChanged)}}class lt extends o.ReactWidget{constructor(e){super(),this._collaborators=[],this._fileopener=e,this.addClass("jp-CollaboratorsList")}get collaborators(){return this._collaborators}set collaborators(e){this._collaborators=e,this.update()}render(){return this._collaborators.map(((e,t)=>{let s=!1,n="",o="",r="";if(e.current){s=!0;const t=e.current.split(":");r=`${t[1]}:${t[2]}`,n=f.PathExt.basename(t[2]),n=n.length>25?n.slice(0,12).concat("…"):n,o="•"}const a=`${e.user.display_name} ${o} ${n}`;return nt.createElement("div",{className:s?`jp-ClickableCollaborator ${it}`:it,key:t,onClick:()=>{s&&this._fileopener(r)}},nt.createElement("div",{className:"jp-CollaboratorIcon",style:{backgroundColor:e.user.color}},nt.createElement("span",null,e.user.initials)),nt.createElement("span",null,a))}))}}var dt=s(98204),ht=s(66211);const ut=dt.Facet.define({combine:e=>e[e.length-1]}),pt=ht.EditorView.baseTheme({".jp-remote-cursor":{borderLeft:"1px solid black",marginLeft:"-1px"},".jp-remote-cursor.jp-mod-primary":{borderLeftWidth:"2px"},".jp-remote-selection":{opacity:.5},".cm-tooltip":{border:"none"},".cm-tooltip .jp-remote-userInfo":{color:"var(--jp-ui-inverse-font-color0)",padding:"0px 2px"}}),ft=dt.Annotation.define();class gt{constructor(e,t){this.style=e,this.marker=t}draw(){const e=this.marker.draw();for(const[t,s]of Object.entries(this.style))e.style[t]=s;return e}eq(e){return this.marker.eq(e.marker)&&u.JSONExt.deepEqual(this.style,e.style)}update(e,t){for(const[t,s]of Object.entries(this.style))e.style[t]=s;return this.marker.update(e,t.marker)}}const mt=(0,ht.layer)({above:!0,markers(e){const{awareness:t,ytext:s}=e.state.facet(ut),n=s.doc,o=[];return t.getStates().forEach(((r,a)=>{var i,c,l;if(a===t.doc.clientID)return;const d=r.cursors;for(const t of null!=d?d:[]){if(!(null==t?void 0:t.anchor)||!(null==t?void 0:t.head))return;const a=(0,y.createAbsolutePositionFromRelativePosition)(t.anchor,n),d=(0,y.createAbsolutePositionFromRelativePosition)(t.head,n);if((null==a?void 0:a.type)!==s||(null==d?void 0:d.type)!==s)return;const h=null===(i=t.primary)||void 0===i||i?"jp-remote-cursor jp-mod-primary":"jp-remote-cursor",u=dt.EditorSelection.cursor(d.index,d.index>a.index?-1:1);for(const t of ht.RectangleMarker.forRange(e,h,u))o.push(new gt({borderLeftColor:null!==(l=null===(c=r.user)||void 0===c?void 0:c.color)&&void 0!==l?l:"black"},t))}})),o},update:(e,t)=>!!e.transactions.find((e=>e.annotation(ft))),class:"jp-remote-cursors"}),yt=(0,ht.hoverTooltip)(((e,t)=>{var s;const{awareness:n,ytext:o}=e.state.facet(ut),r=o.doc;for(const[e,a]of n.getStates())if(e!==n.doc.clientID)for(const e of null!==(s=a.cursors)&&void 0!==s?s:[]){if(!(null==e?void 0:e.head))continue;const s=(0,y.createAbsolutePositionFromRelativePosition)(e.head,r);if((null==s?void 0:s.type)===o&&s.index-1<=t&&t<=s.index+1)return{pos:s.index,above:!0,create:()=>{var e,t,s,n;const o=document.createElement("div");return o.classList.add("jp-remote-userInfo"),o.style.backgroundColor=null!==(t=null===(e=a.user)||void 0===e?void 0:e.color)&&void 0!==t?t:"darkgrey",o.textContent=null!==(n=null===(s=a.user)||void 0===s?void 0:s.display_name)&&void 0!==n?n:"Anonymous",{dom:o}}}}return null}),{hideOn:(e,t)=>!!e.annotation(ft)}),bt=(0,ht.layer)({above:!1,markers(e){const{awareness:t,ytext:s}=e.state.facet(ut),n=s.doc,o=[];return t.getStates().forEach(((r,a)=>{var i,c,l;if(a===t.doc.clientID)return;const d=r.cursors;for(const t of null!=d?d:[]){if(null===(i=t.empty)||void 0===i||i||!(null==t?void 0:t.anchor)||!(null==t?void 0:t.head))return;const a=(0,y.createAbsolutePositionFromRelativePosition)(t.anchor,n),d=(0,y.createAbsolutePositionFromRelativePosition)(t.head,n);if((null==a?void 0:a.type)!==s||(null==d?void 0:d.type)!==s)return;const h="jp-remote-selection";for(const t of ht.RectangleMarker.forRange(e,h,dt.EditorSelection.range(a.index,d.index)))o.push(new gt({backgroundColor:null!==(l=null===(c=r.user)||void 0===c?void 0:c.color)&&void 0!==l?l:"black"},t))}})),o},update:(e,t)=>!!e.transactions.find((e=>e.annotation(ft))),class:"jp-remote-selections"}),vt=ht.ViewPlugin.fromClass(class{constructor(e){this.editorAwareness=e.state.facet(ut),this._listener=({added:t,updated:s,removed:n})=>{t.concat(s).concat(n).findIndex((e=>e!==this.editorAwareness.awareness.doc.clientID))>=0&&e.dispatch({annotations:[ft.of([])]})},this.editorAwareness.awareness.on("change",this._listener)}destroy(){this.editorAwareness.awareness.off("change",this._listener)}update(e){var t;if(!e.docChanged&&!e.selectionSet)return;const{awareness:s,ytext:n}=this.editorAwareness,o=s.getLocalState();if(o){const r=e.view.hasFocus&&e.view.dom.ownerDocument.hasFocus(),a=e.state.selection,i=new Array;if(r&&a){for(const e of a.ranges){const t=e===a.main,s=(0,y.createRelativePositionFromTypeIndex)(n,e.anchor),o=(0,y.createRelativePositionFromTypeIndex)(n,e.head);i.push({anchor:s,head:o,primary:t,empty:e.empty})}if(!o.cursors||i.length>0){const e=null===(t=o.cursors)||void 0===t?void 0:t.map((e=>({...e,anchor:(null==e?void 0:e.anchor)?(0,y.createRelativePositionFromJSON)(e.anchor):null,head:(null==e?void 0:e.head)?(0,y.createRelativePositionFromJSON)(e.head):null})));u.JSONExt.deepEqual(i,e)||s.setLocalStateField("cursors",i)}}}}},{provide:()=>[pt,mt,bt,yt,(0,ht.tooltips)({position:"absolute",parent:document.body})]});var wt;!function(e){e[e.CHAT=125]="CHAT"}(wt||(wt={}));class _t extends Be{constructor(e){super(e.url,e.roomID,e.awareness.doc,{awareness:e.awareness}),this._isDisposed=!1,this._awareness=e.awareness;const t=e.user;t.ready.then((()=>this._onUserChanged(t))).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._chatMessage=new m.Signal(this),this.messageHandlers[wt.CHAT]=(e,t,s,n,o)=>{const r=Ce(t),a=JSON.parse(r);console.debug("Chat:",a),this._chatMessage.emit(a)}}get isDisposed(){return this._isDisposed}get chatMessage(){return this._chatMessage}dispose(){this._isDisposed||(this.destroy(),this._isDisposed=!0)}sendMessage(e){console.debug("Send message:",e);const t=oe();ce(t,wt.CHAT),he(t,e),this.ws.send(ae(t))}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}var Ct=s(11175);const kt={id:"@jupyter/collaboration-extension:userMenu",description:"Provide connected user menu.",requires:[],provides:Xe,activate:e=>{const{commands:t}=e,{user:s}=e.serviceManager;return new st({commands:t,user:s})}},It={id:"@jupyter/collaboration-extension:user-menu-bar",description:"Add user menu to the interface.",autoStart:!0,requires:[Xe,o.IToolbarWidgetRegistry],activate:async(e,t,s)=>{const{user:n}=e.serviceManager,o=new Qe.MenuBar({forceItemsPosition:{forceX:!1,forceY:!1},renderer:new tt(n)});o.id="jp-UserMenu",n.userChanged.connect((()=>o.update())),o.addMenu(t),s.addFactory("TopBar","user-menu",(()=>o))}},St={id:"@jupyter/collaboration-extension:rtcGlobalAwareness",description:"Add global awareness to share working document of users.",requires:[Ct.IStateDB],provides:Ze,activate:(e,t)=>{const{user:s}=e.serviceManager,n=new y.Doc,o=new je(n),r=g.ServerConnection.makeSettings(),a=f.URLExt.join(r.wsUrl,"api/collaboration/room");return new _t({url:a,roomID:"JupyterLab:globalAwareness",awareness:o,user:s}),t.changed.connect((async()=>{var e,s;const n=(null===(s=null===(e=(await t.toJSON())["layout-restorer:data"])||void 0===e?void 0:e.main)||void 0===s?void 0:s.current)||"";n.startsWith("editor")||n.startsWith("notebook")?o.setLocalStateField("current",n):o.setLocalStateField("current",null)})),o}},xt={id:"@jupyter/collaboration-extension:rtcPanel",description:"Add side panel to display all currently connected users.",autoStart:!0,requires:[Ze],optional:[d.ITranslator],activate:(e,t,s)=>{const{user:n}=e.serviceManager,r=(null!=s?s:d.nullTranslator).load("jupyter_collaboration"),a=new Ke.SidePanel({alignment:"justify"});a.id=o.DOMUtils.createDomID(),a.title.icon=Ke.usersIcon,a.title.caption=r.__("Collaboration"),a.addClass("jp-RTCPanel"),e.shell.add(a,"left",{rank:300});const i=new rt(n);i.title.label=r.__("User info"),i.title.caption=r.__("User information"),a.addWidget(i);const c=new ct(n,t,(t=>{e.commands.execute("docmanager:open",{path:t})}));c.title.label=r.__("Online Collaborators"),a.addWidget(c)}},At={id:"@jupyter/collaboration-extension:userEditorCursors",description:"Add CodeMirror extension to display remote user cursors and selections.",autoStart:!0,requires:[Ye.IEditorExtensionRegistry],activate:(e,t)=>{t.addExtension({name:"remote-user-cursors",factory(e){const{awareness:t,ysource:s}=e.model.sharedModel;return Ye.EditorExtensionRegistry.createImmutableExtension((n={awareness:t,ytext:s},[ut.of(n),vt]));var n}})}};class jt extends Qe.Widget{constructor(e,t,s,n){super(),this._url=e,this._token=t,this._behindHub=s,this._trans=n,this._tokenCheckbox=null,this.onTokenChange=e=>{const t=e.target;this.updateContent(null==t?void 0:t.checked)},this._warning=document.createElement("div"),this.populateBody(this.node),this.addClass("jp-shared-link-body")}getValue(){var e;if(!0===(null===(e=this._tokenCheckbox)||void 0===e?void 0:e.checked)){const e=new URL(this._url);return e.searchParams.set("token",this._token),e.toString()}return this._url}onAfterAttach(e){var t;super.onAfterAttach(e),null===(t=this._tokenCheckbox)||void 0===t||t.addEventListener("change",this.onTokenChange)}onBeforeDetach(e){var t;null===(t=this._tokenCheckbox)||void 0===t||t.removeEventListener("change",this.onTokenChange),super.onBeforeDetach(e)}updateContent(e){this._warning.innerHTML="";const t=this.node.querySelector("input[readonly]");if(e){if(t){const e=new URL(this._url);e.searchParams.set("token",this._token.slice(0,5)),t.value=e.toString()+"…"}this._warning.appendChild(document.createElement("h3")).textContent=this._trans.__("Security warning!"),this._warning.insertAdjacentText("beforeend",this._trans.__("Anyone with this link has full access to your notebook server, including all your files!")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._warning.insertAdjacentText("beforeend",this._trans.__("Please be careful who you share it with.")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._behindHub?(this._warning.insertAdjacentText("beforeend",this._trans.__("They will be able to access this server AS YOU.")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._warning.insertAdjacentText("beforeend",this._trans.__("To revoke access, go to File -> Hub Control Panel, and restart your server."))):this._warning.insertAdjacentText("beforeend",this._trans.__("Currently, there is no way to revoke access other than shutting down your server."))}else t&&(t.value=this._url),this._behindHub?this._warning.insertAdjacentText("beforeend",this._trans.__("Only users with `access:servers` permissions for this server will be able to use this link.")):this._warning.insertAdjacentText("beforeend",this._trans.__("Only authenticated users will be able to use this link."))}populateBody(e){if(e.insertAdjacentHTML("afterbegin",`<input readonly value="${this._url}">`),this._token){const t=e.appendChild(document.createElement("label"));t.insertAdjacentHTML("beforeend",'<input type="checkbox">'),this._tokenCheckbox=t.firstChild,t.insertAdjacentText("beforeend",this._trans.__("Include token in URL")),e.insertAdjacentElement("beforeend",this._warning),this.updateContent(!1)}}}var Mt;!function(e){e.share="collaboration:shared-link"}(Mt||(Mt={}));const Ut=[He,qe,Je,ze,Ge,kt,It,St,xt,{id:"@jupyter/collaboration-extension:shared-link",autoStart:!0,optional:[o.ICommandPalette,d.ITranslator],activate:async(e,t,s)=>{const{commands:n}=e,r=(null!=s?s:d.nullTranslator).load("collaboration");n.addCommand(Mt.share,{label:r.__("Generate a Shared Link"),icon:Ke.shareIcon,execute:async()=>{const e=await async function({translator:e}){const t=(null!=e?e:d.nullTranslator).load("collaboration"),s=f.PageConfig.getToken(),n=new URL(f.URLExt.normalize(f.PageConfig.getUrl({workspace:f.PageConfig.defaultWorkspace})));return(0,o.showDialog)({title:t.__("Share Jupyter Server Link"),body:new jt(n.toString(),s,""!==f.PageConfig.getOption("hubUser"),t),buttons:[o.Dialog.cancelButton(),o.Dialog.okButton({label:t.__("Copy Link"),caption:t.__("Copy the link to the Jupyter Server")})]})}({translator:s});e.button.accept&&e.value&&o.Clipboard.copyToSystem(e.value)}}),t&&t.addItem({command:Mt.share,category:r.__("Server")})}},At]}}]);